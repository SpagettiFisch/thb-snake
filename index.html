<html>
    <head>
        <style>
        </style>
        <script type="module">                  
            import kaboom from "https://unpkg.com/kaboom/dist/kaboom.mjs";

            var snake_length = 2;
            let snake_body = []
            const block_size = 32
            const directions = {
                UP: "up",
                DOWN: "down",
                LEFT: "left",
                RIGHT: "right"
            };
            let direction = directions.RIGHT;
            let run_action = false;
            let move_delay = 0.2;
            let timer = 0;

            kaboom({
                width: 480,
                height: 480,
                font: "sinko",
                canvas: document.querySelector("#mycanvas"),
                background: [153, 230, 0],
            });
            //loadSprite("frodo", "Frodo.jpg");

            //Spawn
            function respawn_snake(){
                destroyAll("snake");
                snake_length = 2;
                snake_body = []
                for(let i = 1; i <= snake_length; i++){
                    let segment = add([
                    //sprite("frodo"),
                    area(),
                    rect(block_size, block_size),
                    pos(block_size, block_size * i),
                    color(51, 51, 255),
                    "snake"
                    ])
                    snake_body.push(segment)
                    }
                    direction = directions.RIGHT
            }

            function respawn_all(){
                run_action = false;
                wait(0.5, function(){
                respawn_snake();
                run_action = true;
            });
        }

            function move_snake(direction){
            for(let i = 1; i <= snake_length; i++){
                let segment = add([
                //sprite("frodo"),
                area(),
                rect(16, 16),
                pos(+10, +0),
                color(51, 51, 255),
                "snake"
                ])
                snake_body.push(segment)
                }
            }
            respawn_all()
            //move_snake(direction)

            onUpdate(()=> {
                if (!run_action) return;
                timer += dt();
                if (timer < move_delay) return;
                timer = 0;

                let move_x = 0;
                let move_y = 0;

                switch (direction) {
                    case directions.DOWN:
                        move_x = 0;
                        move_y = block_size;
                        break;
                    case directions.UP:
                        move_x = 0;
                        move_y = -1*block_size;
                        break;
                    case directions.LEFT:
                        move_x = -1*block_size;
                        move_y = 0;
                        break;
                    case directions.RIGHT:
                        move_x = block_size;
                        move_y = 0;
                        break;
                }
                let snake_head = snake_body[snake_body.length - 1];

                snake_body.push(add([
                    rect(block_size,block_size),
                    pos(snake_head.pos.x + move_x, snake_head.pos.y + move_y),
                    color(0,0,255),
                    area(),
                    "snake"
                ]));

                if (snake_body.length > snake_length){
                    let tail = snake_body.shift(); // Remove the last of the tail
                    destroy(tail);
                }

            });

            onKeyPress("up", () => {
                if (direction != directions.DOWN){
                    direction = directions.UP;
                }
            });

            onKeyPress("down", () => {
                if (direction != directions.UP){
                    direction = directions.DOWN;
                }
            });

            onKeyPress("left", () => {
                if (direction != directions.RIGHT){
                    direction = directions.LEFT;
                }
            });

            onKeyPress("right", () => {
                if (direction != directions.LEFT){
                    direction = directions.RIGHT;
                }
            });

            onKeyPress("space", () => {
                create_snake()
            })
            
            
            onCollide("player","border", (border) => {
                destroy(player)
                go("lose")

            })

            onCollide("player", "fruit", (fruit) => {
                snake_length++
            })

            let fruit = add([
            
            ])
            
            
            addLevel([
    "===============",
    "=             =",
    "=             =",
    "=             =",
    "=             =",
    "=             =",
    "=             =",
    "=             =",
    "=             =",
    "=             =",
    "=             =",
    "=             =",
    "=             =",
    "=             =",
    "==============="

], {
    width: block_size,
    height: block_size,
    
    "=": () =>[
    pos(0, 0),
    rect(block_size, block_size),
    color(255,0,0),
    area(),
    "border"
    ],
})

            
            

            </script>
    </head>
    <body>

    </body>
</html>
